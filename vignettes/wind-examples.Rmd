---
title: "GenEst 101--Tutorial with Examples"
author: "Dan Dalthorp"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{GenEst 101--Tutorial with Examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, include=FALSE}
rm(list = ls())

library(GenEst)
vers <- packageVersion("GenEst")
today <- Sys.Date()
set.seed(445)
```
# Introduction: Tutorial with Examples
This tutorial provides an introduction to the array of command line tools
**GenEst** provides for estimating carcass arrivals and detection
probabilities. The approach is to walk through analyses of realistic but 
fictitious data sets representing studies of bird and bat mortality at a
wind power facility.

The tutorial was constructed using **GenEst** version `r vers` on `r today`.

## Example 1: Estimating Bat Mortality from Searches on Roads and Pads

Searcher efficiency and carcass persistence would be expected to vary with
carcass size (sparrow, eagle, bat), ground characteristics (road & pad,
cleared field, vegetation), season, etc. In this first example, we limit the
basic mortality estimation to one carcass size (`bat`) and one ground 
visibility class (`RP` = road and pad). Once the initial estimates have been 
calculated, the total mortality can be parsed into any number of "splits", 
estimating mortality by species, turbine, visibility class, season, search 
interval, month, etc. or by combinations of splitting covariates, like species 
by season, size by turbine, etc.

Load the full data set into R:
```{r}
data(wind_RPbat)
names(wind_RPbat)
```
`wind_RPbat` is a list of data frames that store results for searcher 
efficiency (`SE`) and carcass persistence trials (`CP`), search schedules for 
all turbines (`SS`), the density weighted proportion (`DWP`) of area searched
at each turbine (i.e., the fraction of carcasses expected to fall in the 
search plots), and a carcass observation (`CO`) data. To streamline the 
notation, we will extract the data from the `wind_RPbat` list into its 
components:
```{r}
data_SE <- wind_RPbat$SE
data_CP <- wind_RPbat$CP
data_SS <- wind_RPbat$SS
data_DWP <- wind_RPbat$DWP
data_CO <- wind_RPbat$CO
```

```{r, include = FALSE}
daterange <- range(data_SS$SearchDate)
seasons <- paste(unique(data_SS$Season), collapse = ', ')
```

### Searcher Efficiency (`SE`)
Searcher efficiency trials were conducted on roads and pads, with a total of
`r  dim(data_SE)[1]` fresh carcasses placed in the field over the course of
the entire monitoring period, evenly divided among seasons (`r seasons`). 
Carcasses that were later discovered by search teams during the course of 
normal carcass surveys were removed from the field. Carcasses were left in 
the field for up to 5 searches after carcass placement.

Results of the SE field trials are stored in the `data_SE` data frame:
```{r}
head(data_SE)
```
Columns `s1, s2, ..., s5` show the fate of carcass `pkID` on the 1st, 2nd, ...
5th searches after the carcass was placed. A 1 indicates that the carcass was
discovered, a 0 indicates that the carcass was present but not discovered, and
NA indicates that the carcass was not present (whether it was discovered in a
previous search or removed by scavengers) or no search was conducted.

### Carcass Persistence (`CP`)
Carcass persistence trials were conducted on roads and pads, with a total of
`r  dim(data_CP)[1]` fresh carcasses placed in the field over the course of
the entire monitoring period, evenly divided among seasons (`r seasons`). 
Carcasses were checked (approximately) 1, 2, 3, 4, 7, 10, 14, 21, and 28 
days after placement in the field (exact times were entered as decimal 
fractions of days after placement).

Results of the SE field trials are stored in the `data_CP` data frame:
```{r}
head(data_CP)
```

Exact scavenging times are not known, but a carcass that was present at one
check and absent at the next check is assumed to have been scavenged at some
point in the interval. The left endpoint of the interval is entered as `Left`
and the right endpoint as `Right`. For carcasses that had not been scavenged
by the end of the study, `Left` is the time of the last check and `Right` 
is `Inf`. For carcasses whose scavenging time is known exactly (e.g., the 
scavenging was recorded by camera), `Left = Right`.

The `Season` column gives the season at the time the carcass was placed in the
field.

### Search Schedules (`SS`)
Carcass searches were conducted on roads and pads within a 120 m radius from 
all `r length(unique(data_SS$SearchDate))` turbines at a fictitious wind power
facility. Monitoring began on `r daterange[1]` and continued through
`r daterange[2]`. Searches spanned `r length(unique(data_SS$Season))` seasons:
`r seasons`. Search intervals varied by turbine and by time of year, ranging 
from daily searches at some turbines in the fall and searches once every 12 
days in the spring at some other turbines. Search schedules for all turbines 
are stored in `data_SS`, which is a data frame with a column for search dates
(including all dates that any turbine was searched); a column of 0s and 1s for 
each turbine, indication whether it was searched on the given date; and zero 
or more optional columns giving additional information about the date (e.g.,
season).
```{r}
head(data_SS[, 1:10])
print("NOTE: there are 100 turbine columns altogether (t1, ..., t100)")
```

### Density Weighted Proportion (`DWP`)
The density-weighted proportion (`DWP`) is the expected fraction of carcasses
that fell in the searched area. Carcass density is not the same at all distances
from a turbine, but typically rises over a short distance then decreases
eventually to 0. Searches were conducted on roads and pads within a 120 m
radius from all 100 turbines to provide sufficient data with which to model the
change in density with distance and from this, accurately calculate the fraction
of all carcasses that are expected to land on road and pad surrounding each
turbine (density-weighted proportion or DWP). The exact configuration of the
roads and pads differs among turbines, hence the DWP must be calculated for each
turbine. DWPs for bats at each turbine are stored in `data_DWP`, which is a data
frame with a column for turbine (values must match column names in `data_SS`);
a column of DWP labeled `bat`. In other studies where, for example, mortality of
birds might be of interest, `DWP` would be expected vary with carcass size or
species (e.g., the spatial distributions of bats and large birds around a
turbine would like differ from one another). In that case, each carcass size
class (`large`, `medium`, `small`, `bat`) would have its own column.
```{r}
head(data_DWP)
```

### Carcass Observations (`CO`)
Information about each (non-trial) carcass observed during searches is stored in
`CO_data` which is a data frame with at least 4 columns: carcass ID, the turbine
(or unit) at which it was found, the date it was found and its distance from the
turbine center. In `CO_data` for we also have turbine type, species, and species
group, variables by which we will later summarize mortality estimates.
```{r}
head(data_CO)
```

### Estimating Searcher Efficiency and Carcass Persistence Parameters
Searcher efficiency and carcass persistence parameters are estimated by fitting
models using functions `pkm` and `cpm` which are patterned after familar R
functions such as `lm` and `glm`. In this relatively simple example, our SE and
CP field trials were conducted for one carcass size (bat) on one type of terrain
(roads and pads) in three seasons (spring, summer, fall). The only potential
predictor variable we have is `Season`, which is entered as a column in both
`data_SE` and `data_CP`.

```{r, eval = FALSE}
?pkm
```
```{r}
model_SE <- pkm(p ~ Season, k ~ 1, data = data_SE)
```
```{r, eval = FALSE}
?cpm
```
```{r}
model_CP <- cpm(l ~ Season, s ~ Season, data = data_CP,
  left = "Left", right = "Right")
```
In other scenarios we might consider other predictors like visibility of the
ground searched or search team. We might also be interested in carcasses of
different sizes (e.g., large, medium, and small birds instead of or in addition
to bats). We are not restricted to using the same predictors of both SE and CP.
The modeling complexity increases with each additional predictor, but, in
theory, any number of predictors can be used. The only rule is that sufficient
numbers of trial carcasses must be placed in each cell combination of factor
levels among the selected predictors. For example, if we were to place 15
carcasses for each cell for predictors that include season (spring, summer,
fall, winter), size (S, M, L, B), visibility (RP, M, D), search team (dogs,
humans), and turbine type (small, medium, large), we'd need
15 x 4 x 4 x 3 x 2 x 2 = 2880 carcasses. Typically, the number of predictors is
limited to a few key variables.

### Mortality Estimation
Each carcass's contribution to the total mortality in each search search
interval is estimated using the `estM`.

```{r, eval = FALSE}
?estM
```
```{r, fig.height = 4, fig.width = 6, fig.align = 'center'}
Mhat <- estM(nsim = 10, data_CO = data_CO, data_SS = data_SS,
  data_DWP = data_DWP, model_SE = model_SE, model_CP = model_CP,
  unitCol = "Turbine", dateFoundCol = "DateFound")

summary(Mhat)
plot(Mhat)
```
The estimate of total mortality can be summarized by any number of subcategories
or "splits". For example, we may wish to know the number of fatalities by
season, species, species group, search interval, turbine, week, etc.

Splits may be done according to characteristics of the carcasses or where they
were found (e.g., species, turbine or other variable found in data_CO) or when
they were found (e.g., season or other variable associated with search
schedule and found in data_SS, or a list of times).


```{r, eval = FALSE}
?calcSplits
```

Species (a CO split because it is a column in the CO file):
```{r, fig.height = 4.5, fig.width = 4.5, fig.align = 'center'}
M_species <- calcSplits(M = Mhat$Mhat, Aj = Mhat$Aj, split_CO = "Species",
  data_CO = data_CO)
summary(M_species)
plot(M_species)
```

Mortality estimates may also be split by temporal variables that are represented
as columns in ``data_SS`` or as numeric vectors spanning the monitoring
season (from day 0 to length of monitoring season). If several temporal splits
are to be calculated, creating a specially formatted ``SS`` object for the
search schedule can streamline the calculations.
```{r}
SSdat <- SS(data_SS)
```

Season (a SS split because it is a column in the SS file):
```{r, fig.height = 5, fig.width = 5, fig.align = 'center'}
M_season <- calcSplits(M = Mhat$Mhat, Aj = Mhat$Aj,
  split_SS = "Season", data_SS = SSdat, split_CO = NULL,  data_CO = data_CO)
summary(M_season)
plot(M_season)
```

Month (a temporal split that as a vector of times spanning monitoring season):
```{r, fig.height = 5, fig.width = 8, fig.align = 'center'}
M_month <- calcSplits(M = Mhat$Mhat, Aj = Mhat$Aj,
  split_time = seq(0, max(SSdat$days), by = 28),
  data_SS = SSdat, data_CO = data_CO)
summary(M_month)
plot(M_month)
```
Temporal splits that divide the monitoring season into separate time intervals
(like season or month) can be plotted as the number per interval
(`rate = FALSE`, which is the default arg in `calcSplits`) or the number per
unit time (`rate = TRUE`).
```{r, fig.height = 4, fig.width = 7, fig.align = 'center'}
M_various_times <- calcSplits(M = Mhat$Mhat, Aj = Mhat$Aj,
  split_time = c(seq(0, 90, by = 15), 120, 150, seq(155, 200, by = 5)),
  data_SS = SSdat, data_CO = data_CO)
summary(M_various_times)
plot(M_various_times)
plot(M_various_times, rate = TRUE)
```

Finally, splits can be calculated for combinations of splitting covariates,
like species by season or species group by turbine type. No more than two
splitting covariates may be used in one call to `calcSplits` and at most one
temporal split may be used (whether it is an SS split or a vector of times).

```{r, fig.height = 6, fig.width = 3.5, fig.align = 'center'}
M_species_by_season <- calcSplits(M = Mhat$Mhat, Aj = Mhat$Aj,
  split_CO = "Species", data_CO = data_CO,
  split_SS = "Season", data_SS = SSdat)
plot(M_species_by_season)
```

